<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AiList - 现代化的文件管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .file-item:hover .file-actions {
            display: flex;
        }
        .file-actions {
            display: none;
        }
        .logo {
            width: 48px;
            height: 48px;
            margin-right: 16px;
        }
        .logo svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- 顶部导航栏 -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between h-20">
                    <div class="flex items-center">
                        <div class="logo">
                            <img src="/static/logo.svg" alt="AiList Logo">
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800">AiList</h1>
                    </div>
                    <div class="flex items-center">
                        <button id="settingsBtn" class="text-gray-600 hover:text-gray-900 text-xl">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要内容区域 -->
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- 工具栏 -->
            <div class="bg-white shadow rounded-lg mb-6 p-4">
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <div class="relative">
                            <select id="storageSelector" class="appearance-none bg-white border rounded-lg px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">选择存储池...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <i class="fas fa-chevron-down"></i>
                            </div>
                        </div>
                        <button id="newStorageBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            新建存储池
                        </button>
                        <button id="uploadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-upload mr-2"></i>
                            上传文件
                        </button>
                        <input type="file" id="fileInput" class="hidden" multiple>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="搜索文件..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件列表 -->
            <div class="bg-white shadow rounded-lg">
                <div class="p-4">
                    <div id="fileList" class="space-y-2">
                        <!-- 文件列表将通过 JavaScript 动态加载 -->
                    </div>
                </div>
            </div>
        </main>

        <!-- 设置对话框 -->
        <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white rounded-lg p-8 max-w-md w-full">
                    <h2 class="text-2xl font-bold mb-6">存储设置</h2>
                    <form id="storageForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">存储池名称</label>
                            <input type="text" id="storageName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">存储类型</label>
                            <select id="storageType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="local">本地存储</option>
                                <option value="s3">S3 存储</option>
                            </select>
                        </div>
                        <div id="localConfig" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">存储路径</label>
                                <input type="text" id="localPath" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <div id="s3Config" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Access Key</label>
                                <input type="text" id="s3AccessKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Secret Key</label>
                                <input type="password" id="s3SecretKey" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Bucket</label>
                                <input type="text" id="s3Bucket" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Region</label>
                                <input type="text" id="s3Region" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="cancelBtn" class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">取消</button>
                            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentStorage = null;

        // DOM 元素
        const settingsBtn = document.getElementById('settingsBtn');
        const newStorageBtn = document.getElementById('newStorageBtn');
        const settingsModal = document.getElementById('settingsModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const storageForm = document.getElementById('storageForm');
        const storageType = document.getElementById('storageType');
        const localConfig = document.getElementById('localConfig');
        const s3Config = document.getElementById('s3Config');
        const fileList = document.getElementById('fileList');
        const searchInput = document.getElementById('searchInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const storageSelector = document.getElementById('storageSelector');

        // 显示设置对话框
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.remove('hidden');
            loadStorageConfig();
        });

        // 显示新建存储池对话框
        newStorageBtn.addEventListener('click', () => {
            // 清空表单
            document.getElementById('storageName').value = '';
            document.getElementById('storageType').value = 'local';
            document.getElementById('localPath').value = '';
            document.getElementById('s3AccessKey').value = '';
            document.getElementById('s3SecretKey').value = '';
            document.getElementById('s3Bucket').value = '';
            document.getElementById('s3Region').value = '';
            
            // 显示对话框
            settingsModal.classList.remove('hidden');
            // 显示本地存储配置
            localConfig.classList.remove('hidden');
            s3Config.classList.add('hidden');
        });

        // 隐藏设置对话框
        cancelBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        // 存储类型切换
        storageType.addEventListener('change', () => {
            if (storageType.value === 'local') {
                localConfig.classList.remove('hidden');
                s3Config.classList.add('hidden');
            } else {
                localConfig.classList.add('hidden');
                s3Config.classList.remove('hidden');
            }
        });

        // 加载存储配置
        async function loadStorageConfig() {
            try {
                const response = await fetch('/api/storage/config');
                if (response.ok) {
                    currentStorage = await response.json();
                    document.getElementById('storageName').value = currentStorage.name;
                    document.getElementById('storageType').value = currentStorage.type;
                    
                    const config = JSON.parse(currentStorage.config);
                    if (currentStorage.type === 'local') {
                        document.getElementById('localPath').value = config.path;
                    } else {
                        document.getElementById('s3AccessKey').value = config.access_key;
                        document.getElementById('s3SecretKey').value = config.secret_key;
                        document.getElementById('s3Bucket').value = config.bucket;
                        document.getElementById('s3Region').value = config.region;
                    }
                }
            } catch (error) {
                console.error('加载存储配置失败:', error);
            }
        }

        // 加载存储池列表
        async function loadStorageList() {
            try {
                const response = await fetch('/api/storage/list');
                if (response.ok) {
                    const storages = await response.json();
                    storageSelector.innerHTML = '<option value="">选择存储池...</option>';
                    storages.forEach(storage => {
                        const option = document.createElement('option');
                        option.value = storage.id;
                        option.textContent = storage.name;
                        storageSelector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载存储池列表失败:', error);
            }
        }

        // 切换存储池
        storageSelector.addEventListener('change', async (e) => {
            const storageId = e.target.value;
            if (!storageId) return;

            try {
                const response = await fetch(`/api/storage/switch/${storageId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadFiles();
                }
            } catch (error) {
                console.error('切换存储池失败:', error);
            }
        });

        // 保存存储配置
        storageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {};
            if (storageType.value === 'local') {
                config.path = document.getElementById('localPath').value;
            } else {
                config.access_key = document.getElementById('s3AccessKey').value;
                config.secret_key = document.getElementById('s3SecretKey').value;
                config.bucket = document.getElementById('s3Bucket').value;
                config.region = document.getElementById('s3Region').value;
            }
            
            try {
                const response = await fetch('/api/storage/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: document.getElementById('storageName').value,
                        type: storageType.value,
                        config: JSON.stringify(config)
                    }),
                });
                
                if (response.ok) {
                    settingsModal.classList.add('hidden');
                    loadStorageList(); // 刷新存储池列表
                    loadFiles();
                }
            } catch (error) {
                console.error('保存存储配置失败:', error);
            }
        });

        // 加载文件列表
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                if (response.ok) {
                    const files = await response.json();
                    fileList.innerHTML = '';
                    
                    files.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg';
                        fileItem.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <i class="fas ${file.type === 'directory' ? 'fa-folder text-yellow-500' : 'fa-file text-blue-500'}"></i>
                                <span>${file.name}</span>
                            </div>
                            <div class="file-actions space-x-2">
                                <button class="text-red-500 hover:text-red-700" onclick="deleteFile('${file.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
            }
        }

        // 删除文件
        async function deleteFile(filename) {
            if (!confirm(`确定要删除 ${filename} 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/files/${filename}`, {
                    method: 'DELETE',
                });
                
                if (response.ok) {
                    loadFiles();
                }
            } catch (error) {
                console.error('删除文件失败:', error);
            }
        }

        // 文件上传
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;

            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/files/upload', {
                        method: 'POST',
                        body: formData,
                    });

                    if (response.ok) {
                        loadFiles();
                    }
                } catch (error) {
                    console.error('上传文件失败:', error);
                }
            }

            // 清空文件输入框，以便可以重复上传同一个文件
            fileInput.value = '';
        });

        // 搜索功能
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const fileItems = fileList.getElementsByClassName('file-item');
            
            Array.from(fileItems).forEach(item => {
                const fileName = item.querySelector('span').textContent.toLowerCase();
                if (fileName.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // 初始化
        loadStorageList();
        loadFiles();
    </script>
</body>
</html>